<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churchtools Kalender</title>
    <script src="js/jquery-3.7.1.slim.min.js"></script>
    <script src="js/functions.js"></script>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <style>
        body {
            background-color: wheat;
            font-family: roboto, sans-serif;
        }
        
        #calendar-container {
            display: flex;
            flex-wrap: wrap;
            max-width: 800px;
            margin: 30px auto;
        }
        @media screen and (max-width: 578px) {
            #calendar-container.liste .c_date
            {
                flex-direction: column-reverse;
            }
            #calendar-container.liste .c_picture
            {
                width: 100%;
                min-height: 200px;
            }
        }
    </style>
</head>

<body>
    <div id="calendar-container" class="liste"> </div>
    <div id="flex-container"></div>
    <script>

        // define function to format event
        function getEventDiv(item) {

            // prepare small_note, location, and separator
            const small_note = item.base.note ? item.base.note : "";
            const location = item.base.address ? item.base.address.meetingAt : "";
            var separator = '';
            if (small_note !== '' && location !== '') {
                separator += ' | ';
            };
            
            // prepare information
            var information = '';
            if (item.base.information !== null && item.base.information !== undefined && item.base.information !== "") {
                
                var information = item.base.information;

                // Replace text between *...* by strong tags
                information = information.replace(/\*([^*]+)\*/g, "<strong>$1</strong>");

                // Replace words starting with `https:` or `www.` by links
                information = information.replace(/(https?:\/\/\S+|www\.\S+)/g, '<a href="$1" target="_blank">$1</a>');
                information = information.replace(/\n/g, "<br>");
            }
            
            // prepare image
            var image_filename = "";
                if (item.base.image !== null) {
                    image_filename = item.base.image.fileUrl;
                }
                else {
                    image_filename = "img/calendar.jpg";
                }

            var date_str = formatDates(item.base.startDate, item.base.endDate);
            var result = '<div class="event-box">'
                + '<div class="event-overview">'
                    + '<div class="card overflow-hidden p-3 m-0">'
                        + '<div class="grid-container">'
                            + '<div class="grid-area-image" style="background-image:url(' + image_filename + ')" alt="' + item.base.caption + '"></div>'
                            + '<div class="grid-area-info">'
                                + '<div class="d-flex flex-column h=100">'
                                    + '<div class="baseline">'
                                    + date_str
                                    + '</div>'
                                    + '<div cass="calendar-link">'
                                    + '<a onclick="javascript:createICSFile(' + item.base.startDate + ', ' + item.base.endDate + ', ' + item.base.caption + ', ' + information + ', ' + location + ');">Zum Kalender hinzuf√ºgen</a>'
                                    + '</div>'
                                + '</div>'
                                + '<h1>' + item.base.caption + '</h1>' 
                                + '<h3>' + small_note + separator + location + '</h3>'
                                /*+ '<p>' + information + '</p>'*/
                                + '<div class="mb-2"></div>'
                            + '</div>'
                        + '</div>'
                    + '</div>'
                + '</div>' 
                + '<div class="event-details-collapser">'
                    + '<button class="btn-collapser">Details anzeigen<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-up" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="ml-3 chevron svg-inline--fa fa-chevron-up fa-w-14"><path fill="currentColor" d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z" class=""></path></svg></button>'             
                + '</div>'
            + '</div>';

            return result
        }

        // Fetch the JSON file
        fetch('events.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(object => {
            console.log(object);
            // Iterate over items
            object.data.forEach(item => {
                $('#calendar-container').append(getEventDiv(item))
            });
        })
        .catch(error => {
            console.error('Error fetching or parsing JSON:', error);
        });

    </script>
</body>
</html>
